{% extends "base_sidebar.html" %}

{% block title %}å¡ç‰Œåˆ—è¡¨ - OPCG å¡ç‰Œå›¾é‰´{% endblock %}

{% block main_content %}
<div class="d-flex justify-content-between align-items-center mb-3">
    <h4 class="mb-0">
        <i class="bi bi-grid"></i> 
        {% if current_series %}
            {{ current_series.code }} - å¡ç‰Œåˆ—è¡¨
        {% else %}
            å…¨éƒ¨å¡ç‰Œ
        {% endif %}
    </h4>
    <span class="badge bg-secondary fs-6">{{ pagination.total }} æ¡</span>
</div>

<!-- ç­›é€‰å™¨ï¼ˆç²¾ç®€ç‰ˆï¼Œç³»åˆ—ç­›é€‰ç§»åˆ°ä¾§è¾¹æ ï¼‰ -->
<div class="search-box mb-3">
    <form method="get" action="{{ url_for('cards.card_list') }}">
        <input type="hidden" name="lang" value="{{ request.args.get('lang', 'jp') }}">
        {% if current_series %}
        <input type="hidden" name="series" value="{{ current_series.id }}">
        {% endif %}
        <div class="row g-2 align-items-end">
            <div class="col-auto">
                <label class="form-label small mb-1">ç±»å‹</label>
                <select class="form-select form-select-sm" name="type">
                    <option value="">å…¨éƒ¨</option>
                    <option value="LEADER" {% if request.args.get('type') == 'LEADER' %}selected{% endif %}>LEADER</option>
                    <option value="CHARACTER" {% if request.args.get('type') == 'CHARACTER' %}selected{% endif %}>CHARACTER</option>
                    <option value="EVENT" {% if request.args.get('type') == 'EVENT' %}selected{% endif %}>EVENT</option>
                    <option value="STAGE" {% if request.args.get('type') == 'STAGE' %}selected{% endif %}>STAGE</option>
                </select>
            </div>
            <div class="col-auto">
                <label class="form-label small mb-1">é¢œè‰²</label>
                <select class="form-select form-select-sm" name="color">
                    <option value="">å…¨éƒ¨</option>
                    <option value="èµ¤" {% if request.args.get('color') == 'èµ¤' %}selected{% endif %}>ğŸ”´ èµ¤</option>
                    <option value="ç·‘" {% if request.args.get('color') == 'ç·‘' %}selected{% endif %}>ğŸŸ¢ ç·‘</option>
                    <option value="é’" {% if request.args.get('color') == 'é’' %}selected{% endif %}>ğŸ”µ é’</option>
                    <option value="ç´«" {% if request.args.get('color') == 'ç´«' %}selected{% endif %}>ğŸŸ£ ç´«</option>
                    <option value="é»„" {% if request.args.get('color') == 'é»„' %}selected{% endif %}>ğŸŸ¡ é»„</option>
                    <option value="é»’" {% if request.args.get('color') == 'é»’' %}selected{% endif %}>âš« é»’</option>
                </select>
            </div>
            <div class="col-auto">
                <label class="form-label small mb-1">ç¨€æœ‰åº¦</label>
                <select class="form-select form-select-sm" name="rarity">
                    <option value="">å…¨éƒ¨</option>
                    <option value="L" {% if request.args.get('rarity') == 'L' %}selected{% endif %}>L</option>
                    <option value="SEC" {% if request.args.get('rarity') == 'SEC' %}selected{% endif %}>SEC</option>
                    <option value="SR" {% if request.args.get('rarity') == 'SR' %}selected{% endif %}>SR</option>
                    <option value="R" {% if request.args.get('rarity') == 'R' %}selected{% endif %}>R</option>
                    <option value="UC" {% if request.args.get('rarity') == 'UC' %}selected{% endif %}>UC</option>
                    <option value="C" {% if request.args.get('rarity') == 'C' %}selected{% endif %}>C</option>
                    <option value="SP" {% if request.args.get('rarity') == 'SP' %}selected{% endif %}>SP</option>
                    <option value="TR" {% if request.args.get('rarity') == 'TR' %}selected{% endif %}>TR</option>
                    <option value="P" {% if request.args.get('rarity') == 'P' %}selected{% endif %}>P</option>
                </select>
            </div>
            <div class="col-auto">
                <label class="form-label small mb-1">æ’ç”»</label>
                <select class="form-select form-select-sm" name="illustration">
                    <option value="">å…¨éƒ¨</option>
                    <option value="åŸä½œ" {% if request.args.get('illustration') == 'åŸä½œ' %}selected{% endif %}>ğŸ“– åŸä½œ</option>
                    <option value="ã‚¢ãƒ‹ãƒ¡" {% if request.args.get('illustration') == 'ã‚¢ãƒ‹ãƒ¡' %}selected{% endif %}>ğŸ“º åŠ¨ç”»</option>
                    <option value="ã‚ªãƒªã‚¸ãƒŠãƒ«" {% if request.args.get('illustration') == 'ã‚ªãƒªã‚¸ãƒŠãƒ«' %}selected{% endif %}>ğŸ¨ åŸåˆ›</option>
                    <option value="ãã®ä»–" {% if request.args.get('illustration') == 'ãã®ä»–' %}selected{% endif %}>ğŸ“ å…¶ä»–</option>
                </select>
            </div>
            <div class="col-auto">
                <label class="form-label small mb-1">æ˜Ÿæ ‡</label>
                <select class="form-select form-select-sm" name="star">
                    <option value="">å…¨éƒ¨</option>
                    <option value="1" {% if request.args.get('star') == '1' %}selected{% endif %}>â­ æœ‰æ˜Ÿæ ‡</option>
                    <option value="0" {% if request.args.get('star') == '0' %}selected{% endif %}>æ— æ˜Ÿæ ‡</option>
                </select>
            </div>
            <div class="col-auto">
                <button type="submit" class="btn btn-primary btn-sm">
                    <i class="bi bi-funnel"></i> ç­›é€‰
                </button>
            </div>
            <div class="col-auto">
                <a href="{{ url_for('cards.card_list', lang=request.args.get('lang', 'jp'), series=request.args.get('series', '')) }}" 
                   class="btn btn-outline-secondary btn-sm">
                    <i class="bi bi-x"></i> æ¸…é™¤
                </a>
            </div>
        </div>
    </form>
</div>

<!-- å¡ç‰Œç½‘æ ¼ -->
{% if cards %}
<div class="card-grid">
    {% for card in cards %}
    <div class="card-item">
        {% set version_id_param = card.display_version_id %}
        {% set from_series_param = request.args.get('series', '') %}
        <a href="{{ url_for('cards.card_detail', card_number=card.card_number, lang=request.args.get('lang', 'jp'), version_id=version_id_param, from_series=from_series_param) if version_id_param else url_for('cards.card_detail', card_number=card.card_number, lang=request.args.get('lang', 'jp'), from_series=from_series_param) }}" class="text-decoration-none">
            {% set first_version = card.versions.first() %}
            {% set first_image = first_version.images.first() if first_version else None %}
            {% if first_image %}
            <img src="{{ first_image.original_url|cdn_image(200) }}" 
                 alt="{{ card.name }}" 
                 class="card-image"
                 loading="lazy">
            {% else %}
            <div class="card-image bg-secondary d-flex align-items-center justify-content-center" style="height: 280px;">
                <i class="bi bi-image text-white display-4"></i>
            </div>
            {% endif %}
            <div class="mt-2">
                <div class="d-flex justify-content-between align-items-center">
                    <small class="text-muted">{{ card.card_number }}</small>
                    <div>
                        {% if card.has_star_mark %}<span class="badge bg-warning text-dark" title="æ˜Ÿæ ‡å¼‚ç”»">â­</span>{% endif %}
                        <span class="rarity-{{ card.rarity }}">{{ card.rarity }}</span>
                    </div>
                </div>
                <p class="mb-0 text-dark fw-bold small">{{ card.name[:20] }}{% if card.name|length > 20 %}...{% endif %}</p>
                <div>
                    {% for color in card.colors.split('/') %}
                    <span class="color-badge color-{{ color }}"></span>
                    {% endfor %}
                    <small class="text-muted">{{ card.card_type }}</small>
                </div>
                {% if card.source_description %}
                <div class="mt-1">
                    <small class="text-info" style="font-size: 0.7rem;">
                        <i class="bi bi-box-seam"></i> {{ card.source_description[:30] }}{% if card.source_description|length > 30 %}...{% endif %}
                    </small>
                </div>
                {% endif %}
            </div>
        </a>
    </div>
    {% endfor %}
</div>

<!-- åˆ†é¡µ -->
{% if pagination.pages > 1 %}
{% set filter_args = {'series': request.args.get('series', ''), 'type': request.args.get('type', ''), 'color': request.args.get('color', ''), 'rarity': request.args.get('rarity', ''), 'illustration': request.args.get('illustration', ''), 'star': request.args.get('star', ''), 'lang': request.args.get('lang', 'jp')} %}
<nav class="mt-4">
    <ul class="pagination justify-content-center flex-wrap">
        {% if pagination.has_prev %}
        <li class="page-item">
            <a class="page-link" href="{{ url_for('cards.card_list', page=pagination.prev_num, **filter_args) }}">
                <i class="bi bi-chevron-left"></i>
            </a>
        </li>
        {% endif %}
        
        {% for p in pagination.iter_pages() %}
            {% if p %}
                <li class="page-item {% if p == pagination.page %}active{% endif %}">
                    <a class="page-link" href="{{ url_for('cards.card_list', page=p, **filter_args) }}">{{ p }}</a>
                </li>
            {% else %}
                <li class="page-item disabled"><span class="page-link">...</span></li>
            {% endif %}
        {% endfor %}
        
        {% if pagination.has_next %}
        <li class="page-item">
            <a class="page-link" href="{{ url_for('cards.card_list', page=pagination.next_num, **filter_args) }}">
                <i class="bi bi-chevron-right"></i>
            </a>
        </li>
        {% endif %}
    </ul>
</nav>
{% endif %}

{% else %}
<div class="text-center py-5">
    <i class="bi bi-inbox display-1 text-muted"></i>
    <p class="text-muted mt-3">æœªæ‰¾åˆ°å¡ç‰Œ</p>
</div>
{% endif %}
{% endblock %}
