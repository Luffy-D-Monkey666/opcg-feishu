{% extends "base.html" %}

{% block title %}{{ card.name }} - OPCG TCG Manager{% endblock %}

{% block content %}
<nav aria-label="breadcrumb" class="mb-3">
    <ol class="breadcrumb">
        <li class="breadcrumb-item"><a href="{{ url_for('main.index') }}">首页</a></li>
        <li class="breadcrumb-item"><a href="{{ url_for('cards.card_list', lang=current_lang) }}">卡牌列表</a></li>
        {% if display_series %}
        <li class="breadcrumb-item"><a href="{{ url_for('cards.card_list', series=display_series.id, lang=current_lang) }}">{{ display_series.code }}</a></li>
        {% else %}
        <li class="breadcrumb-item"><a href="{{ url_for('cards.card_list', series=card.series_id, lang=current_lang) }}">{{ card.series.code }}</a></li>
        {% endif %}
        <li class="breadcrumb-item active">{{ card.card_number }}</li>
    </ol>
</nav>

<div class="row">
    <!-- 卡牌画像 -->
    <div class="col-md-4">
        {% if versions %}
        <div id="cardCarousel" class="carousel slide" data-bs-ride="false">
            <div class="carousel-inner">
                {% for version in versions %}
                    {% if version.images_list %}
                    {% set ver_img = version.images_list[0] %}
                    {% set ver_img_url = ver_img.local_path if ver_img.local_path else ver_img.original_url %}
                    <div class="carousel-item {% if loop.first %}active{% endif %}">
                        <img src="{{ ver_img_url }}" 
                             class="d-block w-100 rounded shadow" 
                             alt="{{ card.name }} {{ version.version_type }}">
                        <div class="carousel-caption d-block bg-dark bg-opacity-75 rounded py-1">
                            <small>{{ version.version_type }}{% if version.version_suffix %} ({{ version.version_suffix }}){% endif %}</small>
                        </div>
                    </div>
                    {% endif %}
                {% endfor %}
            </div>
            {% if versions|length > 1 %}
            <button class="carousel-control-prev" type="button" data-bs-target="#cardCarousel" data-bs-slide="prev">
                <span class="carousel-control-prev-icon"></span>
            </button>
            <button class="carousel-control-next" type="button" data-bs-target="#cardCarousel" data-bs-slide="next">
                <span class="carousel-control-next-icon"></span>
            </button>
            {% endif %}
        </div>
        
        <!-- 版本列表 -->
        {% if versions|length >= 1 %}
        <div class="mt-3">
            <small class="text-muted d-block mb-2">{{ versions|length }} 版本</small>
            <div class="list-group list-group-flush" style="max-height: 300px; overflow-y: auto;">
                {% for version in versions %}
                <div class="list-group-item list-group-item-action p-2 {% if loop.first %}active{% endif %}" 
                     role="button"
                     data-bs-target="#cardCarousel" 
                     data-bs-slide-to="{{ loop.index0 }}"
                     onclick="this.parentElement.querySelectorAll('.list-group-item').forEach(i => i.classList.remove('active')); this.classList.add('active');">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <span class="badge bg-{{ 'primary' if version.version_type == 'normal' else 'warning' }} me-1">
                                {{ version.version_type }}
                            </span>
                            {% if version.illustration_type %}
                            <span class="badge bg-info">{{ version.illustration_type }}</span>
                            {% endif %}
                        </div>
                        {% if version.version_suffix %}
                        <small class="text-muted">{{ version.version_suffix }}</small>
                        {% endif %}
                    </div>
                    {% if version.source_description %}
                    <small class="text-muted d-block mt-1" style="font-size: 0.75rem;">
                        <i class="bi bi-box"></i> {{ version.source_description[:50] }}{% if version.source_description|length > 50 %}...{% endif %}
                    </small>
                    {% endif %}
                </div>
                {% endfor %}
            </div>
        </div>
        {% endif %}
        {% endif %}
    </div>
    
    <!-- 卡牌情報 -->
    <div class="col-md-8">
        <div class="d-flex align-items-center mb-3">
            <h2 class="mb-0 me-3">{{ card.name }}</h2>
            <span class="badge bg-secondary me-2">{{ card.card_number }}</span>
            <span class="rarity-{{ card.rarity }} fs-5">{{ card.rarity }}</span>
            <a href="{{ url_for('cards.card_all_versions', card_number=card.card_number, lang=current_lang) }}" 
               class="btn btn-outline-info btn-sm ms-3" 
               title="查看所有图鉴中相同编号的卡片">
                <i class="bi bi-layers"></i> 查看所有版本
            </a>
        </div>
        
        <!-- 收藏/愿望单 ボタン -->
        {% if current_user.is_authenticated %}
        <div class="mb-3" id="actionButtons">
            {% set current_version = versions[0] if versions else none %}
            {% if current_version %}
            <div class="btn-group" role="group">
                <button type="button" class="btn btn-success" id="addCollectionBtn" 
                        data-version-id="{{ current_version.id }}">
                    <i class="bi bi-plus-circle"></i> 收藏に添加
                </button>
                <button type="button" class="btn btn-outline-danger" id="addWishlistBtn"
                        data-version-id="{{ current_version.id }}">
                    <i class="bi bi-heart"></i> 添加到愿望单
                </button>
            </div>
            <div class="mt-2">
                <small class="text-muted" id="collectionStatus">
                    {% if in_collection %}
                    <i class="bi bi-check-circle text-success"></i> 收藏済み ({{ in_collection.quantity }}张)
                    {% endif %}
                    {% if in_wishlist %}
                    <i class="bi bi-heart-fill text-danger"></i> 已加入愿望单
                    {% endif %}
                </small>
            </div>
            {% endif %}
        </div>
        {% else %}
        <div class="mb-3">
            <a href="{{ url_for('auth.login') }}" class="btn btn-outline-primary">
                <i class="bi bi-box-arrow-in-right"></i> 登录后添加到收藏
            </a>
        </div>
        {% endif %}
        
        <!-- 基本信息 -->
        <div class="card mb-3">
            <div class="card-header">
                <i class="bi bi-info-circle"></i> 基本信息
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <table class="table table-sm">
                            <tr>
                                <th width="40%">类型</th>
                                <td>{{ card.card_type }}</td>
                            </tr>
                            <tr>
                                <th>色</th>
                                <td>
                                    {% for color in card.colors.split('/') %}
                                    <span class="color-badge color-{{ color }}"></span>
                                    <span class="me-1">{{ color }}</span>
                                    {% endfor %}
                                </td>
                            </tr>
                            <tr>
                                <th>系列</th>
                                <td id="seriesCell">
                                    {% if display_series %}
                                    <a href="{{ url_for('cards.card_list', series=display_series.id, lang=current_lang) }}" id="seriesLink">
                                        {{ display_series.code }}
                                    </a>
                                    {% else %}
                                    <a href="{{ url_for('cards.card_list', series=card.series_id, lang=current_lang) }}" id="seriesLink">
                                        {{ card.series.code }}
                                    </a>
                                    {% endif %}
                                </td>
                            </tr>
                            {% if card.attribute %}
                            <tr>
                                <th>属性</th>
                                <td>{{ card.attribute }}</td>
                            </tr>
                            {% endif %}
                        </table>
                    </div>
                    <div class="col-md-6">
                        <table class="table table-sm">
                            {% if card.card_type == 'LEADER' %}
                            <tr>
                                <th width="40%">生命</th>
                                <td class="stat-value">{{ card.life }}</td>
                            </tr>
                            {% else %}
                            <tr>
                                <th width="40%">费用</th>
                                <td class="stat-value">{{ card.cost if card.cost is not none else '-' }}</td>
                            </tr>
                            {% endif %}
                            <tr>
                                <th>战力</th>
                                <td class="stat-value">{{ card.power if card.power is not none else '-' }}</td>
                            </tr>
                            <tr>
                                <th>反击</th>
                                <td class="stat-value">{{ card.counter if card.counter is not none else '-' }}</td>
                            </tr>
                            {% if card.block_icon %}
                            <tr>
                                <th>格挡</th>
                                <td>{{ card.block_icon }}</td>
                            </tr>
                            {% endif %}
                        </table>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- 特征 -->
        {% if card.traits %}
        <div class="card mb-3">
            <div class="card-header">
                <i class="bi bi-tags"></i> 特征
            </div>
            <div class="card-body">
                {% for trait in card.traits.split('/') %}
                <span class="badge bg-info me-1">{{ trait }}</span>
                {% endfor %}
            </div>
        </div>
        {% endif %}
        
        <!-- 效果テキスト -->
        {% if card.effect_text %}
        <div class="card mb-3">
            <div class="card-header">
                <i class="bi bi-chat-text"></i> 效果
            </div>
            <div class="card-body">
                <p class="mb-0" style="white-space: pre-line;">{{ card.effect_text }}</p>
            </div>
        </div>
        {% endif %}
        
        <!-- 触发效果 -->
        {% if card.trigger_text %}
        <div class="card mb-3">
            <div class="card-header bg-warning bg-opacity-25">
                <i class="bi bi-lightning"></i> 触发
            </div>
            <div class="card-body">
                <p class="mb-0">{{ card.trigger_text }}</p>
            </div>
        </div>
        {% endif %}
        
        <!-- 获取信息 - 动态显示当前版本的 source_description -->
        <div class="card mb-3" id="sourceInfoCard">
            <div class="card-header">
                <i class="bi bi-box"></i> 获取信息
            </div>
            <div class="card-body">
                <p class="mb-0 text-muted" id="sourceInfoText">
                    {% set current_version = versions[0] if versions else none %}
                    {% if current_version and current_version.source_description %}
                        {{ current_version.source_description }}
                    {% elif card.source_info %}
                        {{ card.source_info }}
                    {% else %}
                        -
                    {% endif %}
                </p>
            </div>
        </div>
        
        <!-- 价格情報 -->
        {% if prices %}
        <div class="card">
            <div class="card-header bg-success bg-opacity-10">
                <i class="bi bi-currency-dollar"></i> 市场价格
            </div>
            <div class="card-body">
                <table class="table table-sm mb-0">
                    <thead>
                        <tr>
                            <th>版本</th>
                            <th class="text-end">价格 (USD)</th>
                            <th class="text-end">更新日期</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for price in prices %}
                        <tr>
                            <td>{{ price.version.version_type }}</td>
                            <td class="text-end fw-bold">${{ '%.2f' % price.price }}</td>
                            <td class="text-end text-muted">{{ price.recorded_at.strftime('%Y-%m-%d') }}</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
                <small class="text-muted">数据来源: OPTCG API</small>
            </div>
        </div>
        {% endif %}
    </div>
</div>

<!-- 同じ系列の卡牌 -->
{% if display_series %}
<div class="mt-5">
    <h4><i class="bi bi-grid-3x3-gap"></i> {{ display_series.code }} 的其他卡牌</h4>
    <div class="card-grid">
        {% for other in same_series_cards[:6] %}
        <div class="card-item">
            <a href="{{ url_for('cards.card_detail', card_number=other.card_number, lang=current_lang, from_series=display_series.id) }}" class="text-decoration-none">
                {% set other_version = other.versions.first() %}
                {% if other_version %}
                    {% set other_image = other_version.images.first() %}
                    {% if other_image %}
                    {% set oi_url = other_image.local_path if other_image.local_path else other_image.original_url %}
                    <img src="{{ oi_url }}" 
                         alt="{{ other.name }}" 
                         class="card-image"
                         loading="lazy">
                    {% endif %}
                {% endif %}
                <div class="mt-2">
                    <small class="text-muted">{{ other.card_number }}</small>
                    <p class="mb-0 text-dark small">{{ other.name[:15] }}...</p>
                </div>
            </a>
        </div>
        {% endfor %}
    </div>
    <div class="text-center mt-3">
        <a href="{{ url_for('cards.card_list', series=display_series.id, lang=current_lang) }}" class="btn btn-outline-secondary">
            查看全部卡牌
        </a>
    </div>
</div>
{% endif %}
{% endblock %}

{% block extra_js %}
<script>
// 版本数据（包含 source_description 和 series 信息）
const versionsData = [
    {% for v in versions %}
    {
        id: {{ v.id }},
        sourceDescription: {{ v.source_description|tojson if v.source_description else 'null' }},
        seriesId: {{ v.series_id if v.series_id else 'null' }},
        seriesCode: {{ v.series.code|tojson if v.series else 'null' }}
    }{% if not loop.last %},{% endif %}
    {% endfor %}
];

// 默认卡片级别的 source_info（fallback）
const cardSourceInfo = {{ card.source_info|tojson if card.source_info else 'null' }};
const cardSeriesId = {{ card.series_id }};
const cardSeriesCode = {{ card.series.code|tojson }};
const currentLang = {{ current_lang|tojson }};

// 更新右侧显示信息的函数
function updateVersionInfo(index) {
    const version = versionsData[index];
    if (!version) return;
    
    // 更新获取信息
    const sourceInfoText = document.getElementById('sourceInfoText');
    if (sourceInfoText) {
        const source = version.sourceDescription || cardSourceInfo || '-';
        sourceInfoText.textContent = source;
    }
    
    // 更新系列
    const seriesLink = document.getElementById('seriesLink');
    if (seriesLink && version.seriesId && version.seriesCode) {
        seriesLink.textContent = version.seriesCode;
        seriesLink.href = `/cards?series=${version.seriesId}&lang=${currentLang}`;
    }
}

// 轮播图切换事件
const carousel = document.getElementById('cardCarousel');
if (carousel) {
    carousel.addEventListener('slid.bs.carousel', function(e) {
        updateVersionInfo(e.to);
        {% if current_user.is_authenticated %}
        // 更新收藏按钮的版本ID
        const currentVersionId = versionsData[e.to]?.id;
        if (currentVersionId) {
            document.getElementById('addCollectionBtn')?.setAttribute('data-version-id', currentVersionId);
            document.getElementById('addWishlistBtn')?.setAttribute('data-version-id', currentVersionId);
        }
        {% endif %}
    });
}

// 版本列表点击事件
document.querySelectorAll('.list-group-item[data-bs-slide-to]').forEach((item, index) => {
    item.addEventListener('click', function() {
        updateVersionInfo(index);
    });
});
</script>

{% if current_user.is_authenticated %}
<script>

// 收藏添加
document.getElementById('addCollectionBtn')?.addEventListener('click', function() {
    const versionId = this.dataset.versionId;
    const btn = this;
    btn.disabled = true;
    
    fetch('/api/collection/add', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({version_id: parseInt(versionId)})
    })
    .then(res => res.json())
    .then(data => {
        if (data.success) {
            const status = document.getElementById('collectionStatus');
            status.innerHTML = '<i class="bi bi-check-circle text-success"></i> 收藏に添加しました！';
            btn.innerHTML = '<i class="bi bi-check"></i> 已添加';
            setTimeout(() => {
                btn.innerHTML = '<i class="bi bi-plus-circle"></i> 再添加一张';
                btn.disabled = false;
            }, 1500);
        }
    })
    .catch(() => btn.disabled = false);
});

// 愿望单添加
document.getElementById('addWishlistBtn')?.addEventListener('click', function() {
    const versionId = this.dataset.versionId;
    const btn = this;
    btn.disabled = true;
    
    fetch('/api/wishlist/add', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({version_id: parseInt(versionId)})
    })
    .then(res => res.json())
    .then(data => {
        if (data.success) {
            const status = document.getElementById('collectionStatus');
            status.innerHTML += ' <i class="bi bi-heart-fill text-danger"></i> 添加到愿望单しました！';
            btn.innerHTML = '<i class="bi bi-heart-fill"></i> 已添加';
            btn.classList.remove('btn-outline-danger');
            btn.classList.add('btn-danger');
        }
    })
    .catch(() => btn.disabled = false);
});
</script>
{% endif %}
{% endblock %}
